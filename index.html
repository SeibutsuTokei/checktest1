<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ä½“è¦–åŠ›ãƒ†ã‚¹ãƒˆ</title>
    <style>
        /* ã€CSS: åŸºæœ¬è¨­å®šã¨ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ã€‘ */
        body { margin: 0; font-family: sans-serif; text-align: center; }
        h1 { margin-top: 10px; }
        #test-area {
            width: 80%;
            max-width: 600px;
            height: 300px;
            background-color: #f0f0f0; 
            margin: 20px auto;
            position: relative;
            border: 2px solid #333;
            overflow: hidden; 
        }

        /* ã€CSS: æ•°å­—ã®æç”»ã€‘ */
        .moving-number-instance {
            position: absolute;
            font-size: 60px; 
            font-weight: bold;
            color: black;
            white-space: nowrap; 
            top: 50%;
            transform: translateY(-50%);
            left: 0; 
        }
        
        /* ã€CSS: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã€‘ */
        #countdown-timer {
            font-size: 80px;
            font-weight: bold;
            color: #cc0000;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* ã€CSS: å›ç­”ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€‘ */
        #answer-input {
            padding: 8px;
            font-size: 20px;
            text-align: center;
            width: 150px;
            margin: 10px;
        }
        #btn-submit-answer {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>å‹•ä½“è¦–åŠ›ãƒ†ã‚¹ãƒˆ</h1>
    <div id="test-area">
        </div>

    <div id="status">æº–å‚™å®Œäº†ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>
    <div id="question" style="margin-bottom: 10px; font-weight: bold;"></div>

    <div id="control-area" class="answer-buttons">
        <button id="btn-start">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        
        <div id="answer-form" style="display: none;">
            <input type="number" id="answer-input" placeholder="æ•°å­—ã‚’å…¥åŠ›" pattern="\d*">
            <button id="btn-submit-answer">å›ç­”ã‚’é€ä¿¡</button>
        </div>
    </div>

    <script>
        const testArea = document.getElementById('test-area');
        const statusDisplay = document.getElementById('status');
        const questionDisplay = document.getElementById('question');
        const startButton = document.getElementById('btn-start');
        const answerForm = document.getElementById('answer-form');
        const answerInput = document.getElementById('answer-input');
        const submitButton = document.getElementById('btn-submit-answer');
        
        // ğŸ’¡ ã€è¤‡åˆDVAã‚²ãƒ¼ãƒ è¨­å®šã€‘
        const BASE_SPEED = 16;       
        const MAX_SPEED = 42;        
        const SPEED_INCREMENT_FACTOR = 0.07; 
        const COUNTDOWN_TIME = 3; 
        
        const TARGET_SIZE_EST = 60; 
        
        const MAX_TOTAL_TRIALS = 20; 
        // â˜…ä¿®æ­£ç‚¹1: 2æ¡ã‚’å¢—ã‚„ã—ã€4æ¡ã‚’å‰Šé™¤ã€‚æœ€å¤§é›£æ˜“åº¦ã‚’3æ¡ã«è¨­å®š
        const RING_COUNT_SEQUENCE = [
            1, 1, // è©¦è¡Œ 1-2
            2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // è©¦è¡Œ 3-12 (2æ¡ x 10å›)
            3, 3, 3, 3, 3, 3, 3, 3 // è©¦è¡Œ 13-20 (3æ¡ x 8å›)
        ];
        
        let currentSpeed = BASE_SPEED; 
        let currentRingCount = 1; 
        
        let score = 0;          
        let totalTrials = 0;    
        let animationFrameId;
        
        let numberElement;           
        let correctNumber = '';      
        let countdownElement; 

        // --- ãƒ•ã‚©ãƒ¼ãƒ é€£æºè¨­å®š ---
        const FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSd00l_bHS8qGgzMBzATRH8ZWYKWlIHMNCCaq1nOhvERueNklw/formResponse"; 
        const SCORE_FIELD_NAME = "entry.1995895806"; 

        // --- æ•°å­—ç”Ÿæˆã¨æ¼¸è¿‘é€Ÿåº¦ ---
        
        /** éš£æ¥ã™ã‚‹æ•°å­—ãŒé€£ç¶šã—ãªã„ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°å­—ã‚’ç”Ÿæˆ */
        function generateRandomNumber(length) {
            let result = '';
            let lastDigit = -1; 

            for (let i = 0; i < length; i++) {
                let newDigit;
                do {
                    if (i === 0 && length > 1) {
                        newDigit = Math.floor(Math.random() * 9) + 1; 
                    } else {
                        newDigit = Math.floor(Math.random() * 10); 
                    }
                } while (newDigit === lastDigit); 
                
                result += newDigit;
                lastDigit = newDigit; 
            }
            return result;
        }

        function createNumberElement(number) {
            const container = document.createElement('div');
            container.className = 'moving-number-instance';
            container.textContent = number;
            
            container.positionX = -TARGET_SIZE_EST * currentRingCount; 
            container.style.left = container.positionX + 'px';
            
            return container;
        }
        
        function calculateNextSpeed(current) {
            return current + (MAX_SPEED - current) * SPEED_INCREMENT_FACTOR;
        }


        function startTrial() {
            if (totalTrials >= MAX_TOTAL_TRIALS) {
                endTest();
                return;
            }
            
            if (countdownElement) {
                countdownElement.remove();
                countdownElement = null;
            }

            currentRingCount = RING_COUNT_SEQUENCE[totalTrials]; 
            totalTrials++;
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            testArea.innerHTML = ''; 
            
            correctNumber = generateRandomNumber(currentRingCount);
            numberElement = createNumberElement(correctNumber);
            
            testArea.appendChild(numberElement);
            
            statusDisplay.textContent = `è©¦è¡Œ ${totalTrials} / ${MAX_TOTAL_TRIALS}å›ï¼šæ•°å­— ${currentRingCount}æ¡`;
            questionDisplay.textContent = '';
            
            hideAnswerForm();
            
            animationFrameId = requestAnimationFrame(moveTarget);
        }

        function moveTarget() {
            const testAreaWidth = testArea.clientWidth;
            
            numberElement.positionX += currentSpeed; 
            numberElement.style.left = numberElement.positionX + 'px';

            if (numberElement.positionX >= testAreaWidth) {
                cancelAnimationFrame(animationFrameId);
                numberElement.style.display = 'none';
                startAnswerPhase(); 
            } else {
                animationFrameId = requestAnimationFrame(moveTarget);
            }
        }
        
        function startAnswerPhase() {
            showAnswerForm();
            answerInput.value = '';
            answerInput.focus();
            questionDisplay.textContent = `ã€å›ç­” ${currentRingCount}æ¡ã€‘ è¡¨ç¤ºã•ã‚ŒãŸæ•°å­—ã¯ä½•ã§ã—ãŸã‹ï¼Ÿ`;
            statusDisplay.textContent = "æ•°å­—ã‚’å…¥åŠ›ã—ã€é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        }

        function handleAnswer() {
            const selectedAnswer = answerInput.value.trim();
            
            if (selectedAnswer === correctNumber) {
                endTrial();
            } else {
                // âŒ ä¸æ­£è§£ã®å ´åˆï¼šå³åº§ã«ãƒ†ã‚¹ãƒˆçµ‚äº†
                hideAnswerForm();
                questionDisplay.textContent = `ä¸æ­£è§£ï¼ æ­£ã—ã„æ•°å­—ã¯ ${correctNumber} ã§ã—ãŸã€‚`;
                statusDisplay.textContent = `ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼`;
                
                setTimeout(endTest, 1500); 
            }
        }
        
        /** ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ã€‚isInitialStartã§è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†å² */
        function runCountdown(isInitialStart = false) {
            let timeLeft = COUNTDOWN_TIME;
            
            countdownElement = document.createElement('div');
            countdownElement.id = 'countdown-timer';
            testArea.appendChild(countdownElement);
            
            const countdownInterval = setInterval(() => {
                if (timeLeft >= 0) { 
                    if (timeLeft > 0) {
                        countdownElement.textContent = timeLeft;
                    } else {
                        countdownElement.textContent = 'START';
                    }

                    let statusText;
                    const nextRingCount = RING_COUNT_SEQUENCE[totalTrials];

                    if (isInitialStart) {
                        statusText = `ãƒ†ã‚¹ãƒˆé–‹å§‹ã¾ã§ ${timeLeft}ç§’...`;
                    } else {
                        statusText = `æ¬¡ï¼šæ•°å­— ${nextRingCount}æ¡ã€‚ ${timeLeft}ç§’å¾Œã«ã‚¹ã‚¿ãƒ¼ãƒˆ...`;
                    }
                    statusDisplay.textContent = statusText;
                    timeLeft--;
                } else {
                    clearInterval(countdownInterval);
                    startTrial(); // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†å¾Œã€æ¬¡ã®è©¦è¡Œã¸
                }
            }, 1000);
        }

        function endTrial() {
            score++; 
            
            currentSpeed = calculateNextSpeed(currentSpeed);
            
            if (totalTrials >= MAX_TOTAL_TRIALS) {
                endTest();
                return;
            }
            
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
            hideAnswerForm();
            questionDisplay.textContent = `æ­£è§£ï¼ âœ… (æ­£è§£æ•°: ${score}å›)ã€‚`;
            runCountdown(false); // 2å›ç›®ä»¥é™ã®è©¦è¡Œ
        }

        /** ãƒ†ã‚¹ãƒˆå…¨ä½“ã®çµ‚äº†å‡¦ç†ã€‚ã‚¹ã‚³ã‚¢ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã€‚ */
        function endTest() {
            hideAnswerForm();
            startButton.style.display = 'none';
            questionDisplay.textContent = '';
            
            if (countdownElement) {
                countdownElement.remove();
            }

            // ã‚¹ã‚³ã‚¢ã‚’ç”»é¢ã«è¡¨ç¤ºã—ã€æ‰‹å‹•å…¥åŠ›ã‚’ä¿ƒã™
            statusDisplay.innerHTML = `
                <strong style="color: green; font-size: 24px;">ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼</strong><br>
                æœ€çµ‚ã‚¹ã‚³ã‚¢ (æ­£è§£æ•°): <span style="font-size: 36px; color: #cc0000;">${score}</span> / ${MAX_TOTAL_TRIALS}è©¦è¡Œ<br>
                <br>
                ã“ã®ã‚¹ã‚³ã‚¢ã‚’Googleãƒ•ã‚©ãƒ¼ãƒ ã«æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
            `;
        }

        // --- UIè¡¨ç¤º/éè¡¨ç¤ºã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function showAnswerForm() {
            answerForm.style.display = 'block';
            submitButton.disabled = false;
        }

        function hideAnswerForm() {
            answerForm.style.display = 'none';
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
        startButton.addEventListener('click', () => {
            startButton.style.display = 'none';
            
            // åˆå›ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            score = 0;
            totalTrials = 0;
            currentSpeed = BASE_SPEED;
            
            // åˆå›ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹
            runCountdown(true); 
        });

        submitButton.addEventListener('click', handleAnswer);

        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleAnswer();
                e.preventDefault(); 
            }
        });
    </script>
</body>
</html>

