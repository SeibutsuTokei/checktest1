<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVAè¤‡åˆè­˜åˆ¥ãƒ†ã‚¹ãƒˆ</title>
    <style>
        /* ã€CSS: åŸºæœ¬è¨­å®šã¨ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ã€‘ */
        body { margin: 0; font-family: sans-serif; text-align: center; }
        h1 { margin-top: 10px; }
        #test-area {
            /* â˜…ä¿®æ­£ç‚¹1: è¡¨ç¤ºç¯„å›²ã®èª¿æ•´â˜… */
            width: 80%;
            max-width: 600px;
            height: 300px;
            background-color: #f0f0f0; /* èƒŒæ™¯è‰² */
            margin: 20px auto;
            position: relative;
            border: 2px solid #333;
            overflow: hidden; 
        }

        /* ã€CSS: ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°ã®æç”» - æœ€çµ‚ç¢ºå®šç‰ˆã€‘ */
        .landolt-ring-instance {
            position: absolute;
            width: var(--diameter);
            height: var(--diameter);
            display: block; 
        }

        .landolt-ring-instance > .ring-body {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: var(--ring-thickness) solid black; 
            background-color: #f0f0f0; 
            box-sizing: border-box; 
        }
        
        .landolt-ring-instance > .ring-body::after {
            content: '';
            position: absolute;
            width: calc(var(--notch-size) * 3); 
            height: var(--notch-size); 
            background-color: #f0f0f0; 
            top: 50%; 
            right: calc(0px - var(--notch-size) * 1.5); 
            transform: translateY(-50%);
        }
        
        /* ã€CSS: å›ç­”ãƒœã‚¿ãƒ³ã¨è³ªå•ãƒ†ã‚­ã‚¹ãƒˆã€‘ */
        .answer-buttons { margin-top: 20px; }
        .answer-buttons button {
            padding: 10px 20px;
            font-size: 18px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>DVAè¤‡åˆè­˜åˆ¥ãƒ†ã‚¹ãƒˆï¼ˆé€£ç¶šæ­£è§£ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼‰</h1>
    <div id="test-area">
        </div>

    <div id="status">æº–å‚™å®Œäº†ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>
    <div id="question" style="margin-bottom: 10px; font-weight: bold;"></div>

    <div class="answer-buttons">
        <button id="btn-start">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <button id="btn-up" data-direction="up" style="display: none;">ä¸Š</button>
        <button id="btn-down" data-direction="down" style="display: none;">ä¸‹</button>
        <button id="btn-left" data-direction="left" style="display: none;">å·¦</button>
        <button id="btn-right" data-direction="right" style="display: none;">å³</button>
    </div>

    <script>
        const testArea = document.getElementById('test-area');
        const statusDisplay = document.getElementById('status');
        const questionDisplay = document.getElementById('question');
        const startButton = document.getElementById('btn-start');
        const answerButtons = document.querySelectorAll('.answer-buttons button[data-direction]');
        
        // ğŸ’¡ ã€è¤‡åˆDVAã‚²ãƒ¼ãƒ è¨­å®š - æœ€çµ‚ç¢ºå®šã€‘
        // â˜…ä¿®æ­£ç‚¹2: åˆæœŸé€Ÿåº¦ã¨æœ€å¤§é€Ÿåº¦ã®èª¿æ•´â˜…
        const BASE_SPEED = 12;       // æœ€åˆã®é€Ÿåº¦ (px/frame)
        const MAX_SPEED = 35;        // æ¼¸è¿‘ã™ã‚‹ç›®æ¨™ã®æœ€å¤§é€Ÿåº¦ (px/frame)
        const SPEED_INCREMENT_FACTOR = 0.05; 
        const INITIAL_RING_SIZE = 60; 
        
        const MAX_TOTAL_TRIALS = 15; 
        const RING_COUNT_SEQUENCE = [
            1, 1, 
            2, 2, 2, 2, 2, 2, 
            3, 3, 3, 3, 3, 3, 3 
        ];
        
        const DIRECTIONS = ['up', 'down', 'left', 'right'];
        
        let currentSpeed = BASE_SPEED; 
        let currentRingSize = INITIAL_RING_SIZE;
        let currentRingCount = 1; 
        
        let score = 0;          
        let totalTrials = 0;    
        let animationFrameId;
        
        let ringElements = [];          
        let correctDirections = [];     
        let currentQuestionIndex = 0;   

        // --- ãƒ•ã‚©ãƒ¼ãƒ é€£æºè¨­å®š ---
        const FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSd00l_bHS8qGgzMBzATRH8ZWYKWlIHMNCCaq1nOhvERueNklw/viewform"; 
        const SCORE_FIELD_NAME = "entry.1995895806"; 

        // --- ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°ã®ç”Ÿæˆã¨åˆ¶å¾¡ ---
        
        function setRingStyle(element, diameter, rotationDeg) {
            const ringThickness = diameter / 5;       
            const notchSize = diameter / 5;           

            element.style.setProperty('--diameter', diameter + 'px');
            element.querySelector('.ring-body').style.setProperty('--ring-thickness', ringThickness + 'px');
            element.querySelector('.ring-body').style.setProperty('--notch-size', notchSize + 'px');
            
            element.querySelector('.ring-body').style.transform = `rotate(${rotationDeg}deg)`;
        }

        function createLandoltRingElement(diameter, index) {
            const container = document.createElement('div');
            container.className = 'landolt-ring-instance';
            
            const ringBody = document.createElement('div');
            ringBody.className = 'ring-body';
            
            container.appendChild(ringBody);
            
            container.positionX = -diameter; 
            container.style.left = container.positionX + 'px';
            
            const testAreaHeight = testArea.clientHeight;
            const yPosition = (testAreaHeight / 2) - (diameter / 2);
            container.style.top = yPosition + 'px';
            
            const horizontalSpacing = 10; 
            const totalWidth = (currentRingCount * diameter) + ((currentRingCount - 1) * horizontalSpacing);
            const initialGroupOffset = totalWidth + 50; 
            const relativeOffset = index * (diameter + horizontalSpacing);
            
            container.positionX = -(initialGroupOffset - relativeOffset);
            container.style.left = container.positionX + 'px';

            return container;
        }
        
        /** é€Ÿåº¦ã‚’MAX_SPEEDã«æ¼¸è¿‘ã•ã›ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ */
        function calculateNextSpeed(current) {
            return current + (MAX_SPEED - current) * SPEED_INCREMENT_FACTOR;
        }


        function startTrial() {
            if (totalTrials >= MAX_TOTAL_TRIALS) {
                endTest();
                return;
            }
            
            currentRingCount = RING_COUNT_SEQUENCE[totalTrials]; 
            totalTrials++;
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            testArea.innerHTML = ''; 
            ringElements = []; 
            correctDirections = []; 
            currentQuestionIndex = 0;

            for (let i = 0; i < currentRingCount; i++) {
                const direction = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                correctDirections.push(direction); 
                
                let rotationDeg;
                if (direction === 'up') rotationDeg = 270;      
                else if (direction === 'right') rotationDeg = 0;   
                else if (direction === 'down') rotationDeg = 90;  
                else if (direction === 'left') rotationDeg = 180; 

                const ringElement = createLandoltRingElement(currentRingSize, i);
                setRingStyle(ringElement, currentRingSize, rotationDeg);
                testArea.appendChild(ringElement);
                ringElements.push(ringElement);
            }

            statusDisplay.textContent = `è©¦è¡Œ ${totalTrials} / ${MAX_TOTAL_TRIALS}å›ï¼šç’°ã®æ•° ${currentRingCount}å€‹`;
            questionDisplay.textContent = '';
            
            hideButtons();
            
            animationFrameId = requestAnimationFrame(moveTarget);
        }

        function moveTarget() {
            const testAreaWidth = testArea.clientWidth;
            const lastRing = ringElements[ringElements.length - 1]; 
            const maxX = testAreaWidth; 
            let finished = false;

            ringElements.forEach(ring => {
                ring.positionX += currentSpeed; 
                ring.style.left = ring.positionX + 'px';
            });

            if (lastRing && lastRing.positionX + currentRingSize >= maxX) {
                finished = true;
            }

            if (finished) {
                cancelAnimationFrame(animationFrameId);
                ringElements.forEach(ring => ring.style.display = 'none');
                startAnswerPhase(); 
            } else {
                animationFrameId = requestAnimationFrame(moveTarget);
            }
        }
        
        function startAnswerPhase() {
            showButtons();
            answerButtons.forEach(b => b.disabled = false);
            askNextQuestion();
        }

        function askNextQuestion() {
            if (currentQuestionIndex < currentRingCount) {
                questionDisplay.textContent = `ã€å›ç­” ${currentQuestionIndex + 1} / ${currentRingCount}ã€‘ å·¦ã‹ã‚‰${currentQuestionIndex + 1}ç•ªç›®ã®ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°ã®åˆ‡ã‚Œç›®ã®æ–¹å‘ã¯ï¼Ÿ`;
                statusDisplay.textContent = "å›ç­”ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
            } else {
                endTrial();
            }
        }
        
        function handleAnswer(selectedDirection) {
            answerButtons.forEach(b => b.disabled = true);
            
            const correctDirection = correctDirections[currentQuestionIndex];
            
            if (selectedDirection === correctDirection) {
                currentQuestionIndex++;
                
                if (currentQuestionIndex < currentRingCount) {
                    answerButtons.forEach(b => b.disabled = false); 
                    askNextQuestion(); 
                } else {
                    endTrial();
                }
            } else {
                // âŒ ä¸æ­£è§£ã®å ´åˆï¼šå³åº§ã«ãƒ†ã‚¹ãƒˆçµ‚äº†
                hideButtons();
                questionDisplay.textContent = `ä¸æ­£è§£ï¼`;
                statusDisplay.textContent = `ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼`;
                
                setTimeout(endTest, 1500); 
            }
        }
        
        function endTrial() {
            hideButtons();
            score++; 
            
            currentSpeed = calculateNextSpeed(currentSpeed);
            
            if (totalTrials >= MAX_TOTAL_TRIALS) {
                endTest();
                return;
            }
            
            let nextStatus = `å…¨å•æ­£è§£ï¼ âœ… (æ­£è§£æ•°: ${score}å›)ã€‚`;
            let nextRingCount = RING_COUNT_SEQUENCE[totalTrials]; 

            nextStatus += `æ¬¡ï¼šç’°ã®æ•° ${nextRingCount}å€‹ã€‚`;

            questionDisplay.textContent = '';
            statusDisplay.textContent = nextStatus;
            
            setTimeout(startTrial, 1500); 
        }

        /** ãƒ†ã‚¹ãƒˆå…¨ä½“ã®çµ‚äº†å‡¦ç†ã€‚ã‚¹ã‚³ã‚¢ã‚’Googleãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ã™ã‚‹ã€‚ */
        function endTest() {
            hideButtons();
            questionDisplay.textContent = '';
            statusDisplay.textContent = `ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼æœ€çµ‚ã‚¹ã‚³ã‚¢ (æ­£è§£æ•°): ${score} / ${MAX_TOTAL_TRIALS}è©¦è¡Œ`;
            
            answerButtons.forEach(b => b.disabled = true);

            // Googleãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¹ã‚³ã‚¢ã‚’è‡ªå‹•é€ä¿¡ã—ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            sendScoreToGoogleForm(score); 
        }

        // --- UIè¡¨ç¤º/éè¡¨ç¤ºã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function showButtons() {
            document.getElementById('btn-up').style.display = 'inline-block';
            document.getElementById('btn-down').style.display = 'inline-block';
            document.getElementById('btn-left').style.display = 'inline-block';
            document.getElementById('btn-right').style.display = 'inline-block';
        }

        function hideButtons() {
            document.getElementById('btn-up').style.display = 'none';
            document.getElementById('btn-down').style.display = 'none';
            document.getElementById('btn-left').style.display = 'none';
            document.getElementById('btn-right').style.display = 'none';
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
        startButton.addEventListener('click', () => {
            startButton.style.display = 'none';
            startTrial();
        });

        answerButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                if (!button.disabled) {
                    handleAnswer(e.target.dataset.direction);
                }
            });
        });


        // --- Googleãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•è¨˜éŒ²é–¢æ•° ---

        function sendScoreToGoogleForm(finalScore) {
            const submitUrl = `${FORM_BASE_URL}?${SCORE_FIELD_NAME}=${finalScore}&submit=1`;
            window.location.href = submitUrl;
        }
    </script>
</body>
</html>
